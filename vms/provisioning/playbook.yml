# Ignore on subsequent runs
- hosts: none
  become: yes
  tasks:
    - name: Install essential packets
      apt:
        update_cache: true
        name:
          - net-tools
          - vim
          - tmux
          - libssl-dev
        state: present
    - name: Install Open vSwitch
      when: ovs == true
      apt:
        name: 
          - openvswitch-switch
          - openvswitch-common
        state: present
    - name: Install Python
      when: python == true
      apt:
        name:
          - python3.8
          - python3-pip
          - ipython3
        state: present
    - name: Install dns_ttl.py python package
      when: dnslib == true
      pip:
        name: dnslib
- hosts: ue
  become: yes
  tasks:
    - name: Init network
      shell: |
          ifconfig enp0s8 192.168.57.10 up
          ovs-vsctl del-br br0
          ovs-vsctl add-br br0
          ovs-vsctl set bridge br0 other_config:hwaddr=3a:4d:a7:05:2a:10
          ovs-vsctl add-port br0 gre0 -- set interface gre0 type=gre options:remote_ip=192.168.57.11
          ifconfig br0 10.0.10.10 up
          ovs-ofctl del-flows br0
          ovs-ofctl add-flow br0 in_port=gre0,actions=br0
          ovs-ofctl add-flow br0 in_port=br0,actions=gre0
          ip route del 192.168.57.0/24
          ip route add 192.168.57.11/32 dev enp0s8
          ip route del default
          ip route add default via 10.0.10.11
- hosts: upf
  become: yes
  tasks:
    - name: Init network
      shell: |
          ifconfig enp0s8 192.168.57.11 up
          ovs-vsctl del-br br0
          ovs-vsctl add-br br0
          ovs-vsctl set bridge br0 other_config:hwaddr=3a:4d:a7:05:2a:11
          ovs-vsctl add-port br0 gre0 -- set interface gre0 type=gre options:remote_ip=192.168.57.10
          ovs-vsctl add-port br0 gre1 -- set interface gre1 type=gre options:remote_ip=192.168.57.12
          ifconfig br0 10.0.10.11 up
          # arp -s 10.0.10.12 3a:4d:a7:05:2a:12 
          ovs-ofctl del-flows br0
          ovs-ofctl add-flow br0 in_port=gre0,ip,nw_proto=17,nw_dst=192.168.57.12/32,udp_dst=443,actions=gre1
          ovs-ofctl add-flow br0 in_port=gre0,actions=br0
          ovs-ofctl add-flow br0 in_port=br0,actions=gre0
          ovs-ofctl add-flow br0 in_port=gre1,actions=br0
          # ip route del default
          # ip route add default via 10.0.10.11
          sysctl -w net.ipv4.ip_forward=1
          iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE
          iptables -t nat -A POSTROUTING -o enp0s8 -j MASQUERADE
          iptables -A FORWARD -i br0 -j ACCEPT
- hosts: easdf
  become: yes
  tasks:
    - name: Init network
      shell: |
          ifconfig enp0s8 192.168.57.12 up
          ovs-vsctl del-br br0
          ovs-vsctl add-br br0
          ovs-vsctl set bridge br0 other_config:hwaddr=3a:4d:a7:05:2a:13
          ovs-vsctl add-port br0 gre1 -- set interface gre1 type=gre options:remote_ip=192.168.57.11
          ifconfig br0 10.0.10.12 up
          ovs-ofctl del-flows br0
          ovs-ofctl add-flow br0 in_port=br0,actions=gre1,mod_dl_src:3a:4d:a7:05:2a:11
          ovs-ofctl add-flow br0 in_port=gre1,actions=br0,mod_dl_dst:3a:4d:a7:05:2a:13
    - name: Init python 3.11
      shell: |
          add-apt-repository -y ppa:deadsnakes/ppa
          apt update
          apt install -y python3.11-dev python3.11-distutils
          wget https://bootstrap.pypa.io/get-pip.py
          python3.11 get-pip.py
          python3.11 -m pip install dnslib
# - hosts: pubsub
#   become: yes
#   tasks:
#     - name: Init network
#       shell: |
#           ifconfig enp0s9 192.168.58.14 up
#     - name: Install software
#       apt:
#         name:
#           - mosquitto
#         state: present
- hosts: server1
  become: yes
  tasks:
    - name: Init network
      shell: |
          ifconfig enp0s8 192.168.57.13 up
    - name: Install python libs
      pip:
        name: paho-mqtt
- hosts: server2
  become: yes
  tasks:
    - name: Init network
      shell: |
          ifconfig enp0s8 192.168.57.14 up
    - name: Install python libs
      pip:
        name: paho-mqtt
